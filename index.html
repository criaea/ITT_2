<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUNG TYPOLOGY</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel&family=Comfortaa&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Basic Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        
        body {
            background-color: #f0f4f9; 
            color: #333;
            line-height: 1.6;
            font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            width: 100%;
            margin: 20px auto; 
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
        }

        .question-container {
            margin-bottom: 25px;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }

        .question-container.transitioning {
            opacity: 0;
            transform: translateY(-10px); /* Fades out by moving up */
        }

        .question-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(37, 117, 252, 0.3);
            flex-shrink: 0;
        }
        
        .question-text {
            font-weight: 600;
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.25rem;
            text-align: center;
            line-height: 1.5;
        }
        
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
        }
        
        .option {
            display: flex;
            align-items: center;
            justify-content: center; /* Center text */
            text-align: center; /* Center text */
            padding: 20px;
            border: 2px solid #e0e6ed;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: rgba(248, 249, 250, 0.8);
            min-height: 80px; /* Ensure options have same height */
        }
        
        .option:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border-color: #a0b4c8;
        }
        
        .option.selected {
            background-color: #e3f2fd;
            border-color: #2575fc;
            box-shadow: 0 8px 25px rgba(37, 117, 252, 0.2);
            transform: translateY(-4px);
            color: #2575fc; /* Change text color when selected */
            font-weight: 600; /* Make text bold when selected */
        }
        
        .option input {
            display: none; /* Hide the radio button */
        }
        
        /* --- Navigation Styles --- */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 28px;
            background: linear-gradient(145deg, #5a29e4, #3a68d8);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, background 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 
                        inset 0 1px 1px rgba(255, 255, 255, 0.2);
            text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        button:hover {
            background: linear-gradient(145deg, #6b3ef0, #4c7ce0);
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 
                        0 3px 6px rgba(0, 0, 0, 0.08),
                        inset 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        button:active {
            transform: translateY(1px);
             box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 
                        inset 0 2px 3px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: #7f8c8d;
            text-shadow: none;
        }

        /* --- Cover Page Styles --- */
        #coverPage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Center vertically */
            text-align: center;
            padding: 20px 0; /* Add some vertical padding */
        }

        /* --- Feature List Styles --- */
        .features-list {
            display: flex;
            flex-direction: column;
            gap: 25px; /* Increased gap */
            margin: 30px 0;
            width: 100%;
            max-width: 600px; /* Increased max-width */
            align-items: flex-start; /* Align items to the left of the container */
        }

        .feature-item {
            display: flex;
            align-items: flex-start; /* Align icon to the top */
            gap: 20px;
        }

        .feature-icon {
            width: 100px; /* Standardized size */
            height: auto; /* Maintain aspect ratio */
            border-radius: 0; 
            object-fit: contain; 
            background-color: transparent; 
            box-shadow: none; 
            flex-shrink: 0;
            margin-top: 4px; /* Align icon with first line of text */
        }

        .feature-text-content {
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 4px; /* Small gap between title and description */
        }

        .feature-title {
            font-size: 1.1rem;
            color: #2c3e50;
            font-weight: 600; /* Bolder */
        }
        
        .feature-description {
            font-size: 0.95rem; /* Slightly smaller */
            color: #34495e; 
            font-weight: 400; /* Regular weight */
            line-height: 1.5;
        }

        #coverTitle.cover-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 400;
            margin-bottom: 10px; /* MODIFIED: Was 30px */
            letter-spacing: 1px;
            color: #2c3e50;
        }

        /* --- MODIFIED: Style for the cover page description --- */
        .cover-description {
            font-size: 1.05rem;
            color: #34495e;
            max-width: 650px;
            margin: 0 auto 10px auto; /* MODIFIED: Was -10px auto 10px auto */
            line-height: 1.7;
            text-align: center; /* Ensure it's centered */
        }
        
        /* --- NEW: Style for the sub-description --- */
        .cover-description-sub {
            font-size: 1.05rem;
            color: #34495e;
            max-width: 650px;
            margin: 0 auto 30px auto; /* Top margin 0, bottom margin 30px */
            line-height: 1.7;
            text-align: center; /* Ensure it's centered */
        }
        /* --- END NEW --- */

        /* --- NEW: Style for the copyright subtitle --- */
        .cover-copyright {
            font-size: 0.8rem;
            color: #555;
            text-align: center;
            margin-top: 0; /* MODIFIED: Was -20px */
            margin-bottom: 30px;
        }
        
        .cover-copyright b {
            font-weight: 600;
            color: #333;
        }
        /* --- END NEW --- */

        #startBtn {
            font-family: 'Poppins', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            padding: 15px 40px;
            border-radius: 50px; 
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); 
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(37, 117, 252, 0.3);
            margin-top: 30px;
        }
        
        #startBtn:hover {
            transform: translateY(-3px) scale(1.05); 
            box-shadow: 0 8px 25px rgba(37, 117, 252, 0.4);
        }


        /* --- Results Page Styles --- */
        #resultsPage {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-in-out;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            max-width: 600px; /* Constrain chart width */
            margin: 0 auto;
        }
        
        /* --- MODIFIED: D3 Chart Container Size --- */
        #converse-chart-container {
            max-width: 800px; /* Make it wider than the first chart (600px) */
            height: auto;     /* Let the viewBox aspect ratio (960/500) determine the height */
            margin-top: 0 !important; /* Ensure inline style is respected */
        }
        /* --- END MODIFIED --- */

        /* --- NEW: D3.js Axis Styles --- */
        .axis path,
        .axis line {
            fill: none;
            stroke: #9ca3af; /* gray-400 */
            shape-rendering: crispEdges;
        }
        .axis text {
            fill: #6b7280; /* gray-500 */
            font-size: 0.875rem; /* text-sm */
            font-family: 'Poppins', sans-serif;
        }
        /* Style for the D3 grid lines */
        .grid .tick line {
            shape-rendering: crispEdges;
        }
        /* --- END NEW --- */

        .personality-type-display {
            font-size: 3.5rem; 
            font-weight: 700; 
            color: #2c3e50; 
            text-align: center; 
            margin-top: 25px; 
            letter-spacing: 2px; 
        }

        .personality-words-display {
            font-size: 1.25rem;
            color: #2c3e50; 
            text-align: center;
            letter-spacing: 1px;
            font-weight: 600; 
            padding: 18px 25px; 
            border-bottom: 1px solid #e0e6ed; 
        }
        
        .personality-words-display strong {
             color: #2575fc; /* Use main accent blue */
             font-size: 1.1em; /* Make it slightly larger */
             font-weight: 700; /* Ensure it's bold */
        }
        
        /* --- NEW: Style for the (J) suffix --- */
        .suffix {
            font-size: 0.5em; /* Make it 50% of the parent font size */
            font-weight: 400; /* Lighter weight */
            color: #555; /* Slightly muted color */
            margin-left: 1px; /* Tiny bit of space */
        }
        /* --- END NEW --- */

        .restart-button-container {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .opposite-type-header {
            text-align: center;
            font-size: 1.5rem;
            color: #34495e; 
            font-weight: 600;
            margin-bottom: 20px;
            /* --- MODIFIED: Increased top margin again --- */
            margin-top: 50px; /* Was 30px */
            /* --- NEW: Ensure space below for printing --- */
            margin-bottom: 30px;
        }
        
        /* --- NEW: Apply suffix styling to this header too --- */
        #oppositeTypeHeader .suffix {
             font-size: 0.5em; /* Make it 50% */
             font-weight: 400;
             color: #555;
        }

        .toggle-other-container {
            display: flex;
            justify-content: center;
            margin-top: 25px;
            margin-bottom: 25px;
        }

        .other-toggle-btn {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 50px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            border: 2px solid #a881ef;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px #a881ef, 0 0 20px #a881ef, inset 0 0 5px rgba(255, 255, 255, 0.2);
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.4);
        }
        
        .other-toggle-btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 0 15px #a881ef, 0 0 30px #a881ef, inset 0 0 5px rgba(255, 255, 255, 0.3);
        }

        /* --- Letter Definition Grid Styles --- */
        .letter-definitions-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 20px;
            margin: 30px 0;
            display: none; /* Hidden by default, shown by JS */
        }

        .letter-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-top: 5px solid #ccc; /* Default border, color set by JS */
            transition: all 0.3s ease;
            overflow: hidden; 
        }

        .letter-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .letter-card-title {
            font-weight: 700;
            font-size: 1.25rem;
            color: #2c3e50;
            margin-bottom: 0; 
            padding: 20px; 
            padding-right: 50px; /* for icon */
            cursor: pointer; 
            position: relative; 
            list-style: none; 
        }
        
        .letter-card-title::-webkit-details-marker {
            display: none;
        }

        /* Custom arrow for letter card */
        .letter-card-title::after {
            content: '+';
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem; 
            font-weight: 300;
            color: #2575fc;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease;
        }

        .letter-card[open] > .letter-card-title::after {
            content: '−';
            transform: translateY(-50%) rotate(180deg);
        }

        .letter-card-desc {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #34495e;
            padding: 0 20px 20px 20px; 
        }

        /* --- Result Details Section Styles (Container) --- */
        .results-details {
            margin-top: 40px;
            padding: 30px;
            /* border-top: 1px solid #d1d5db; */ /* Line removed */
            background-color: #f8f9fa; /* Light gray background */
            border-radius: 10px;
            border: 1px solid #e0e6ed;
            box-shadow: 0 4px 15px rgba(0,0,0,0.02);
        }

        .result-section {
            margin-bottom: 15px; 
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e0e6ed;
            overflow: hidden; 
        }

        .result-section[open] {
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
        }

        .result-section-title {
            font-size: 1.25rem; 
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0; 
            padding: 18px 25px;
            border-bottom: none; 
            display: block; 
            cursor: pointer;
            position: relative;
            list-style: none; /* Remove default marker */
        }

        .result-section-title::-webkit-details-marker {
            display: none; 
        }

        /* Custom Accordion Arrow */
        .result-section-title::after {
            content: '+';
            font-family: 'Poppins', sans-serif;
            font-size: 2rem;
            font-weight: 300;
            color: #2575fc;
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease;
        }

        .result-section[open] > .result-section-title::after {
            content: '−'; /* Minus sign */
            transform: translateY(-50%) rotate(180deg);
        }

        .result-section-content {
            font-size: 1.05rem;
            line-height: 1.7;
            color: #34495e;
            padding: 25px; 
        }

        /* Style for the main overview paragraph */
        #desc-overview {
            font-style: italic;
            font-size: 1.1rem;
            color: #2c3e50;
        }

        .placeholder {
            color: #7f8c8d;
            font-style: italic;
        }

        /* --- NEW: Profile Grid Styles --- */
        .profile-grid-container {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e0e6ed;
        }
        
        /* --- MODIFIED: Adjust profile grid container inside results-details --- */
        .results-details .profile-grid-container {
             margin-top: 10px; /* Reduced top margin */
             padding-top: 0; /* No top padding */
             border-top: none; /* No top border */
        }

        .profile-grid-title {
            text-align: center;
            font-size: 1.5rem;
            color: #34495e; 
            font-weight: 600;
            margin-bottom: 25px;
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            border: 1px solid #ccc;
            border-radius: 8px;
            /* overflow: hidden; */ /* --- FIX: Removed to prevent highlight clipping --- */
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            background-color: #fff; /* Ensure white background for cells */
        }

        .profile-cell {
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border 0.2s ease; /* Added border */
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
        }
        
        /* Remove extra borders */
        .profile-cell:nth-child(4n) {
            border-right: none;
        }
        .profile-cell:nth-child(n+13) { /* Last row */
            border-bottom: none;
        }

        .profile-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 10;
        }

        /* --- MODIFIED: New Highlight Style --- */
        .profile-cell.highlight {
            /* Use a distinct background color for the new highlight */
            background-color: #e3f2fd; /* Light blue (from quiz option selected) */
            border: 2px solid #2575fc;
            /* Remove old transform and shadow */
            transform: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); /* Keep a subtle shadow */
            z-index: 11; 
        }
        
        /* Ensure text is readable on new highlight */
        .profile-cell.highlight .profile-cell-type,
        .profile-cell.highlight .profile-cell-title {
            color: #2c3e50; 
        }

        /* Prevent hover effect on the already-highlighted cell */
        .profile-cell.highlight:hover {
             transform: none;
             box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        /* --- END MODIFIED --- */

        .profile-cell-type {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Cinzel', serif;
            margin-bottom: 8px;
        }
        
        .profile-cell-title {
            font-size: 0.8rem;
            font-weight: 500;
            line-height: 1.3;
        }

        /* Colors based on user image */
        .cell-color-a {
            background-color: #f7ead0; /* Lighter tan/orange */
            color: #2c3e50;
        }
        .cell-color-b {
            background-color: #2c3e50; /* Dark blue/grey */
            color: #f7ead0;
        }
        /* --- END NEW: Profile Grid Styles --- */


        /* --- NEW: Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            max-width: 550px;
            width: 100%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            position: relative;
            animation: modalFadeIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2.5rem;
            line-height: 1;
            color: #aaa;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0; /* Reset button padding */
            box-shadow: none; /* Reset button shadow */
            font-weight: 300;
        }
        .modal-close:hover {
            color: #333;
            transform: none; /* Reset button hover */
            box-shadow: none;
        }

        .modal-profile-title {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            margin-bottom: 5px;
        }

        .modal-profile-subtitle {
            font-size: 1.1rem;
            font-weight: 500;
            color: #555;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e6ed;
            padding-bottom: 15px;
        }

        .modal-profile-description {
            font-size: 1.05rem;
            line-height: 1.7;
            color: #34495e;
            font-style: italic;
        }
        /* --- END NEW: Modal Styles --- */

        
        /* --- Mobile Optimizations --- */
        @media (max-width: 768px) {
            body { 
                padding: 0; 
                display: block; /* Allow natural flow on mobile */
            }
            .container {
                border-radius: 0;
                padding: 20px;
                min-height: 100vh;
                width: 100%;
                margin: 0; /* Full width on mobile */
            }
            .navigation { 
                flex-direction: column; 
                gap: 15px; 
            }
            
            .dev-navigation {
                order: -1; /* Move dev button to top on mobile */
                width: 100%;
            }
            
            .dev-navigation button {
                width: 100%;
            }
            
            .navigation button {
                width: 100%; /* Make buttons full width */
            }
            
            .options-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .features-list {
                align-items: center; /* Center list container on mobile */
                max-width: 100%;
                padding: 0 10px;
            }
            
            .feature-item {
                gap: 15px;
                width: 100%; /* Make items take full width */
                max-width: 350px; /* But not too wide */
                align-items: center; /* Center icon and text block vertically */
            }
            
            .feature-icon {
                width: 80px; /* Adjusted mobile size */
                height: auto; /* Maintain aspect ratio */
                margin-top: 0; /* Reset margin */
            }
            
            .feature-title {
                font-size: 1rem; 
            }
            
            .feature-description {
                font-size: 0.9rem;
            }
            
            #coverTitle.cover-title {
                font-size: 2rem;
            }
            #startBtn {
                padding: 12px 30px;
                font-size: 1rem;
            }
            
            /* --- MODIFIED: Adjust section padding for mobile --- */
            .results-details {
                padding: 20px;
            }

            /* --- MODIFIED: Mobile Profile Grid --- */
            .profile-grid-container {
                overflow-x: auto; /* Enable horizontal scrolling */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                page-break-inside: avoid;
            }
            .profile-grid {
                /* Force the grid to be wide, preventing wrapping */
                min-width: 600px; 
            }
            /* --- END MODIFIED --- */
        }
        
        /* --- Print Styles --- */
        @media print {
            #coverPage, 
            #quizSection, 
            .dev-navigation, 
            .toggle-other-container, 
            .restart-button-container, 
            .modal-overlay,
            .container::before,
            .other-toggle-btn,
            #printBtn {
                display: none !important;
            }

            body {
                background-color: #fff;
                font-size: 10pt; /* Smaller font for print */
            }

            .container {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
                overflow: visible !important;
            }
            
            /* --- NEW: Simplify results-details for print --- */
            .results-details {
                background-color: #fff !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin-top: 30px !important;
            }

            #resultsPage {
                display: block !important;
            }

            /* --- Request 1: Page Break Control --- */
            h1, h3, .result-section-title, .letter-card-title, .profile-grid-title {
                page-break-after: avoid;
            }

            .result-section, 
            .letter-card, 
            .profile-grid-container, 
            .result-section-static, 
            .chart-container,
            .profile-grid,
            .results-details { /* --- NEW --- */
                page-break-inside: avoid;
            }

            /* --- Request 2: First Page Content --- */
            #print-page-1 {
                page-break-after: always;
            }
            
            /* Force open all accordions and show all content for printing */
            details {
                open: true !important;
                page-break-inside: avoid;
            }
            
            .letter-card-title::after, 
            .result-section-title::after {
                display: none !important; /* Hide the '+'/'−' icons */
            }

            #letter-grid,
            #other-letter-grid,
            #oppositeTypeHeader,
            #oppositeDesc,
            #personal-discover-section,
            .profile-grid-container {
                display: block !important; /* Ensure these are visible */
            }

            /* --- NEW: Ensure converse chart is visible for printing --- */
            #converse-chart-container {
                display: block !important;
            }
            /* --- END NEW --- */
            
            .chart-container {
                /* Ensure chart is sized well for print */
                height: 350px !important; 
                max-width: 100% !important;
            }
            
            .profile-grid {
                 /* Simplify grid for print if needed, but 'avoid' should be enough */
                 grid-template-columns: repeat(4, 1fr);
            }
        }
        /* --- End Print Styles --- */

    </style>
</head>
<body>
    
    <div class="container">
        
        <div id="coverPage">
            <h1 id="coverTitle" class="cover-title">JUNG TYPOLOGY</h1>
            <p class="cover-copyright">exclusive to <b>ourfields.ie</b> programmes</p>
            
            <p class="cover-description">
                This is a instrument that describes a person's personal style, their own unique way of viewing, responding and relating to the world around them. 
            </p>
            <p class="cover-description-sub">
                It can be used for:
            </p>
            <div class="features-list">
                
                <div class="feature-item">
                    <img src="conflict.png" alt="Improving communications" class="feature-icon" onerror="this.src='https://placehold.co/100x100/6a11cb/ffffff?text=Icon'; this.onerror=null;">
                    <div class="feature-text-content">
                        <h4 class="feature-title">Improving Communications</h4>
                        <p class="feature-description">The test helps build self-esteem and manage conflict by focusing on the positive contributions of each personality type. It gives people a framework for valuing their differences.</p>
                    </div>
                </div>

                <div class="feature-item">
                    <img src="podium.png" alt="Develop individual success" class="feature-icon" onerror="this.src='https://placehold.co/100x100/2575fc/ffffff?text=Icon'; this.onerror=null;">
                    <div class="feature-text-content">
                        <h4 class="feature-title">Develop Individual Success</h4>
                        <p class="feature-description">The test provides practical insight into what motivates and de-motivates an individual. This allows you to map your own personal success and create a plan for improvement.</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <img src="self.png" alt="Better self-understanding" class="feature-icon" onerror="this.src='https://placehold.co/100x100/6a11cb/ffffff?text=Icon'; this.onerror=null;">
                    <div class="feature-text-content">
                        <h4 class="feature-title">Better Self-Understanding</h4>
                        <p class="feature-description">The test helps individuals get to know themselves better, which is a source of great satisfaction. It helps you understand what motivates you and discover your unique potential.</p>
                    </div>
                </div>
                
                <div class="feature-item">
                    <img src="career.png" alt="Career guidance" class="feature-icon" onerror="this.src='https://placehold.co/100x100/2575fc/ffffff?text=Icon'; this.onerror=null;">
                    <div class="feature-text-content">
                        <h4 class="feature-title">Career Guidance</h4>
                        <p class="feature-description">Self-awareness is the key to good career guidance, as personal style affects motivation. The MBTI helps individuals assess which careers or job opportunities are a good fit.</p>
                    </div>
                </div>

            </div>
            <button id="startBtn">Begin the Evaluation</button>
        </div>

        <div id="quizSection" style="display: none;"> 
            <h1>JUNG TYPOLOGY</h1>
            
            <div id="questionnaire">
                <div class="question-container" id="q-container" style="opacity: 0;"> <div class="question-number" id="q-number">1</div>
                    <div class="question-text" id="q-text">Loading...</div>
                    <div class="options-container">
                        <div class="option" id="q-option-0" data-value="">
                            <input type="radio" name="q_radio" id="option0" value="">
                            <label for="option0" id="q-label-0">Option A</label>
                        </div>
                        <div class="option" id="q-option-1" data-value="">
                            <input type="radio" name="q_radio" id="option1" value="">
                            <label for="option1" id="q-label-1">Option B</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dev-navigation" style="text-align: right; margin-bottom: 10px; margin-top: 15px;">
                <button id="randomBtn" style="background: #f39c12; border-color: #f39c12;">Dev: Random Results</button>
            </div>

            <div class="navigation" id="mainNavigation">
                <button id="prevBtn">Previous</button>
                <button id="nextBtn" style="display: none;">Next</button>
                <button id="finishBtn" style="display: none;">Finish</button>
            </div>
        </div>
        
        <div id="resultsPage" style="display: none;">
            
            <div id="print-page-1">
                <h1>Your Results</h1>
                <div class="chart-container">
                    <canvas id="resultsChart"></canvas>
                </div>
                
                <div id="personalityType" class="personality-type-display"></div> 

                <div class="result-section-static">
                    <div id="personalityWords" class="personality-words-display"></div> 
                    <p id="desc-overview" class="result-section-content"></p>
                </div>
            </div>
            <div class="letter-definitions-grid" id="letter-grid">
                <details class="letter-card" id="letter-card-0">
                    <summary class="letter-card-title" id="letter-title-0"></summary>
                    <p class="letter-card-desc" id="letter-desc-0"></p>
                </details>
                <details class="letter-card" id="letter-card-1">
                    <summary class="letter-card-title" id="letter-title-1"></summary>
                    <p class="letter-card-desc" id="letter-desc-1"></p>
                </details>
                <details class="letter-card" id="letter-card-2">
                    <summary class="letter-card-title" id="letter-title-2"></summary>
                    <p class="letter-card-desc" id="letter-desc-2"></p>
                </details>
                <details class="letter-card" id="letter-card-3">
                    <summary class="letter-card-title" id="letter-title-3"></summary>
                    <p class="letter-card-desc" id="letter-desc-3"></p>
                </details>
            </div>
            
            <details class="result-section" id="personal-discover-section">
                <summary class="result-section-title">Personal Discover</summary>
                <div class="result-section-content">
                    <p class="placeholder">[Your personal discovery text will go here...]</p>
                </div>
            </details>

            <!-- --- MODIFIED: This is now the styled container --- -->
            <div class="results-details">
                <div class="toggle-other-container">
                    <button id="showOtherBtn" class="other-toggle-btn">Show Converse Profile</button> 
                </div>

                <div class="chart-container" id="converse-chart-container" style="display: none;">
                    <svg id="converseResultsChart" viewBox="0 0 960 500"></svg>
                </div>
                <h3 id="oppositeTypeHeader" class="opposite-type-header" style="display: none;"></h3>

                <p id="oppositeDesc" class="result-section-content" style="display: none; font-style: italic;"></p>
                <div class="letter-definitions-grid other-letter-grid" id="other-letter-grid">
                    <details class="letter-card other-letter-card" id="other-letter-card-0">
                        <summary class="letter-card-title" id="other-letter-title-0"></summary>
                        <p class="letter-card-desc" id="other-letter-desc-0"></p>
                    </details>
                    <details class="letter-card other-letter-card" id="other-letter-card-1">
                        <summary class="letter-card-title" id="other-letter-title-1"></summary>
                        <p class="letter-card-desc" id="other-letter-desc-1"></p>
                    </details>
                    <details class="letter-card other-letter-card" id="other-letter-card-2">
                        <summary class="letter-card-title" id="other-letter-title-2"></summary>
                        <p class="letter-card-desc" id="other-letter-desc-2"></p>
                    </details>
                    <details class="letter-card other-letter-card" id="other-letter-card-3">
                        <summary class="letter-card-title" id="other-letter-title-3"></summary>
                        <p class="letter-card-desc" id="other-letter-desc-3"></p>
                    </details>
                </div>

                <div class="profile-grid-container">
                    <h3 class="profile-grid-title">Discover Jung's 16 Profiles</h3>
                    <div id="profileGrid" class="profile-grid">
                        </div>
                </div>
            </div>
            
            <div class="restart-button-container">
                 <button id="printBtn">Download / Print Results</button>
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button id="modalCloseBtn" class="modal-close">&times;</button>
            <h4 id="modalTitle" class="modal-profile-title"></h4>
            <p id="modalSubtitle" class="modal-profile-subtitle"></p>
            <p id="modalDescription" class="modal-profile-description"></p>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {

            // --- Questions Data ---
            const questions = [
                { type: "S/N", text: "Are you", options: ["observant of your surroundings", "introspective and thinking"] },
                { type: "E/I", text: "Waiting for the train, do you?", options: ["chat to others", "stay silent"] },
                { type: "T/F", text: "When dealing with people are you?", options: ["Direct", "gentle"] },
                { type: "J/P", text: "Does workplace clutter?", options: ["stress you", "are you indifferent"] },
                { type: "T/F", text: "Which is easier for you to give?", options: ["critical/direct feedback", "avoid the vital details"] },
                { type: "S/N", text: "Do you?", options: ["Keep to the tried and trusted", "speculate about possibilities"] },
                { type: "J/P", text: "Do you?", options: ["decide instantaneously", "linger over decision making"] },
                { type: "S/N", text: "Are you?", options: ["factual", "imaginative"] },
                { type: "E/I", text: "When the phone rings do you?", options: ["rush to it", "leave others get it"] },
                { type: "T/F", text: "Do you place importance on?", options: ["hard data", "opinion"] },
                { type: "J/P", text: "Do you prefer agreements to?", options: ["be written up and signed", "agreed on word and a handshake"] },
                { type: "T/F", text: "When evaluating others are you?", options: ["impersonal and objective", "subjective and personal"] },
                { type: "S/N", text: "Are you more interested in?", options: ["what is real", "what is possible"] },
                { type: "J/P", text: "Are you more at ease?", options: ["When matters are complete", "with work in progress"] },
                { type: "S/N", text: "Are you always", options: ["Up to date with the news", "some what out of touch"] },
                { type: "E/I", text: "When socialising do you?", options: ["speak with many people", "a few friends"] },
                { type: "T/F", text: "When you are communicating with others do you?", options: ["talk directly", "talk diplomatically"] },
                { type: "J/P", text: "Do you prefer?", options: ["a detailed outline of work done", "a list of completed tasks"] },
                { type: "T/F", text: "Do you prefer?", options: ["A rational consistent approach", "harmonious personal approach"] },
                { type: "S/N", text: "Do you like authors who?", options: ["write hard facts", "use metaphors"] },
                { type: "J/P", text: "Are you more comfortable?", options: ["after a decision", "before a decision"] },
                { type: "S/N", text: "Are visionaries?", options: ["annoying", "fascinating"] },
                { type: "E/I", text: "Does being at a party?", options: ["energise you", "drain you"] },
                { type: "T/F", text: "In an argument/discussion do you?", options: ["act confrontational", "do you seek collaborative solutions"] },
                { type: "J/P", text: "For you is giving feedback?", options: ["easy", "difficult"] },
                { type: "T/F", text: "Which is preferable for you?", options: ["to be just", "to be understanding"] },
                { type: "S/N", text: "‘’Common sense’’ is?", options: ["usually reliable", "occasionally questionable"] },
                { type: "J/P", text: "Do you?", options: ["do one job at a time", "work at many jobs simultaneously"] },
                { type: "S/N", text: "Do you say?", options: ["what is on your mind", "express many opinions"] },
                { type: "E/I", text: "In a group of people do you?", options: ["talk a lot", "listen mostly"] },
                { type: "T/F", text: "Which sums you up best?", options: ["cool headed", "warm hearted"] },
                { type: "J/P", text: "Are you?", options: ["organised", "spontaneous"] },
                { type: "T/F", text: "In work situations do you?", options: ["give orders", "get everyone to find solutions"] },
                { type: "S/N", text: "Do you prefer?", options: ["sensible /factual people", "people who explore options"] },
                { type: "J/P", text: "Do you prefer to?", options: ["work to deadlines", "work whenever"] },
                { type: "S/N", text: "Which do you consider best?", options: ["ability to follow a plan", "adapt and adjust plans"] },
                { type: "E/I", text: "Are you?", options: ["a social person", "a private person"] },
                { type: "T/F", text: "Which are you?", options: ["a logical person", "a feeling person"] },
                { type: "J/P", text: "Do you decide?", options: ["based on analysis", "on a considered hunch"] },
                { type: "T/F", text: "Which is most satisfying for you?", options: ["thorough discussion", "reaching agreement"] },
                { type: "S/N", text: "After a meal do you?", options: ["tidy up immediately", "leave it until later"] },
                { type: "J/P", text: "Does your behaviour be?", options: ["hurried", "laid back"] },
                { type: "S/N", text: "Do you hear what is said as?", options: ["all the story", "most of the story"] },
                { type: "E/I", text: "Do you?", options: ["share your feelings easily", "act reserved"] },
                { type: "T/F", text: "Are you?", options: ["an uncompromising person", "a collaborative person"] },
                { type: "J/P", text: "Do you find it?", options: ["is stressful to change", "easy to reschedule meetings"] },
                { type: "T/F", text: "Are you?", options: ["tough minded", "fair minded"] },
                { type: "S/N", text: "When evaluating a situation do you", options: ["see only what is in front of you", "can you imagine more possibilities"] },
                { type: "J/P", text: "Is your approach?", options: ["ensure everything is arranged", "just let things happen"] },
                { type: "S/N", text: "Do you only trust?", options: ["past experiences", "all possibilities are worth checking"] },
                { type: "E/I", text: "Do you?", options: ["know a little about everything", "know much about a few things"] },
                { type: "T/F", text: "Are you convinced, more often, by?", options: ["hard evidence", "possible outside the box solutions"] },
                { type: "J/P", text: "Is your approach to life?", options: ["structure", "flexible"] },
                { type: "T/F", text: "Which is the greatest asset?", options: ["strength of will", "strength of fair compassion"] },
                { type: "S/N", text: "Do you always feel?", options: ["down to earth", "day dream a little"] },
                { type: "J/P", text: "How do you cope with unexpected events?", options: ["get a good handle on things", "get very stressed"] },
                { type: "S/N", text: "Do you act in?", options: ["Routine way", "whimsical way"] },
                { type: "E/I", text: "Are you?", options: ["a good conversationalist", "a good listener"] },
                { type: "T/F", text: "Are you?", options: ["tough skinned", "sensitive"] },
                { type: "J/P", text: "Do you tend to?", options: ["rely on old ways of doing", "be on the look out for new ways"] },
                { type: "T/F", text: "Do you prefer to?", options: ["operate the production machine", "manage the team of people"] },
                { type: "S/N", text: "Are you more?", options: ["practical", "ingenious"] }, 
                { type: "J/P", text: "Are you?", options: ["more punctual", "leisurely /nonchalant"] },
                { type: "S/N", text: "Do you approach work in?", options: ["an organised and principaled way", "in an innovative and flexible way"] },
                { type: "E/I", text: "Are you?", options: ["social and outgoing", "reserved and quite"] },
                { type: "T/F", text: "Do you most trust?", options: ["your experience", "your hunches"] },
                { type: "J/P", text: "Do you", options: ["are always on the go", "relax, easy going"] },
                { type: "T/F", text: "Which is the greatest error?", options: ["being too passionate", "being too objective"] },
                { type: "S/N", text: "Do you tend to be more?", options: ["More deliberate", "more spontaneous"] },
                { type: "J/P", text: "In evaluating others what influences you most?", options: ["laws", "circumstances"] },
                { type: "S/N", text: "Which do you prefer in stories/film?", options: ["action", "fantasy"] },
                { type: "E/I", text: "In your sports club do you?", options: ["promote activities", "do you do the administration"] },
                { type: "T/F", text: "Which is more difficult for you to?", options: ["to identify with others", "to utilise others"] },
                { type: "J/P", text: "Are you?", options: ["a deadlines person", "a just whenever person"] },
                { type: "T/F", text: "Which is most vital?", options: ["following the to do list", "teamwork"] },
                { type: "S/N", text: "Are you?", options: ["easy to talk to/approach", "shy and reserved"] },
                { type: "J/P", text: "When do you plan your annual holidays?", options: ["months before", "weeks before"] },
                { type: "S/N", text: "Are you attracted to?", options: ["the fundamentals", "the promise"] },
                { type: "T/F", text: "For you which is more important?", options: ["follow the rules", "everyone take full responsibility"] },
                { type: "J/P", text: "Do you use?", options: ["written work schedules", "rely on my memory"] }
            ];

            const wordMap = {
                'E': 'Extroverted',
                'I': 'Introverted',
                'S': 'Sensate',
                'N': 'iNtuitive',
                'T': 'Thinking',
                'F': 'Feeling',
                'J': 'Considered', // CHANGED
                'P': 'iMpromptu'   // CHANGED
            };

            const letterDescriptions = {
                'E': `A potential disconnection from the true self, seeking external validation to fill an inner emptiness. A coping mechanism based on attachment needs.`,
                'I': `A possible adaptation of high sensitivity. A protective withdrawal to shield an authentic self that felt overwhelmed or unsafe in the external world.`,
                'S': `A focus on the body's present-moment reality. Can be a path to healing (reconnecting) or a trauma-based disconnection from deeper, painful feelings.`,
                'N': `The "gut feeling" of the authentic self. This inner wisdom is often suppressed by trauma. Healing involves reclaiming and trusting this intuitive voice.`,
                'T': `The rational mind, often split from emotion as a brilliant defense against trauma. Wholeness requires reintegrating this intellect with the heart's feelings.`,
                'F': `The core language of the authentic self. These emotions are often repressed due to childhood wounds, leading to disease. Authenticity is reclaiming all feelings.`,
                'J': `A drive for control and order, often born from a chaotic or unsafe childhood. This rigidity is a survival strategy to create perceived safety.`, // Definition remains
                'P': `A potential "go with the flow" trauma response to avoid conflict, or a healthy openness. Can manifest as difficulty with boundaries or commitment.` // Definition remains
            };

            const personalityDescriptions = {
                // Descriptions remain the same, but are mapped to C(J) and M(P)
                'ISTC(J)': `This deep sense of duty could be an adaptation to feel needed and safe. The wound is a fear of chaos, managed by rigid control. Authenticity comes from learning their worth isn't just in their dependability but in their being.`,
                'ISFC(J)': `A person who likely learned their "value" is in caretaking. This self-sacrificing nature can be an adaptation to suppress their own needs, leading to burnout. Healing means learning to serve themself with the same devotion.`,
                'INFC(J)': `A highly sensitive soul, prone to absorbing others' emotions as a survival tactic. Their profound intuition may be a hyper-vigilance born from needing to "read the room" to be safe. Authenticity is learning to protect their own energy.`,
                'INTC(J)': `This strategic mind may be a defense against a world that felt illogical or emotionally unsafe. By retreating into logic, they found control. Healing involves daring to trust and integrate the "illogical" world of their own feelings.`,
                'ISTM(P)': `A deep-seated need for autonomy, perhaps from feeling controlled or enmeshed. The cool, detached logic can be a shield for a sensitive inner world. True freedom comes from connecting their logical independence with emotional interdependence.`,
                'ISFM(P)': `An authentic, sensitive self that may have learned to be "seen and not heard." Their values are quiet but intense. A wound may be a fear of conflict, leading them to "go with the flow" until a core value is violated.`,
                'INFM(P)': `The "idealist" who may be deeply wounded by the gap between "what should be" and "what is." This sensitivity can be overwhelming. Authenticity is not in fixing the world, but in accepting their own feelings, including anger and grief.`,
                'INTM(P)': `A person who likely found safety in the world of ideas, escaping a world that was emotionally confusing or painful. Their "ivory tower" is a defense. Healing means bringing their brilliant mind "down" into their body and heart.`,
                'ESTM(P)': `This "addiction" to the present moment and high-stimulus activity could be an escape from a painful inner world or past. Stillness feels dangerous. Healing involves learning to be present not just with the outside world, but with their inside one.`,
                'ESFM(P)': `The "performer" who may have learned that their worth comes from being happy and entertaining. This can be a mask for their own pain or sadness. Authenticity means allowing themself to be "off-stage," sad, or still, and know they are still worthy.`,
                'ENFM(P)': `This boundless enthusiasm can be a defense against looking inward. Their fear of "being-pinned-down" may be a trauma response to feeling trapped. Healing means finding the courage to commit and go deep, rather than wide, and to sit with their own discomfort.`,
                'ENTM(P)': `The "devil's advocate" who may use intellectual argument to create distance from their own emotions. This need to "be right" or "win" can be a defense. Authenticity involves realizing that vulnerability is not a logical weakness, but a human strength.`,
                'ESTC(J)': `This powerful need for external order and control may stem from an inner fear of helplessness. Their identity is tied to their effectiveness. True strength would be to embrace vulnerability and accept that "not-knowing" is not a failure.`,
                'ESFC(J)': `A person who lives for "the-we," often at the expense of "the-me." Their identity is built on social approval and being needed. This is a profound trauma adaptation. Healing is a revolutionary act of prioritizing their own needs first.`,
                'ENFC(J)': `This charismatic focus on others' potential can be a way to avoid their own wounds. They "fix" others to avoid fixing themselves. Their greatest challenge is to turn that powerful, compassionate gaze inward and parent their own inner child.`,
                'ENTC(J)': `A powerful will, perhaps forged in an environment where they had to be "strong" to survive. Emotion is seen as a liability to the "mission." Wholeness comes from realizing that their feelings are not obstacles, but essential data for true, authentic leadership.`
            };
            
            // --- NEW: Data for the profile grid ---
            const profileGridData = [
                { type: 'ISTC(J)', title: "Life's Natural Organizers", color: 'a' },
                { type: 'ISFC(J)', title: "Committed to Getting the Job Done", color: 'b' },
                { type: 'INFC(J)', title: "An Inspiring Leader and Follower", color: 'a' },
                { type: 'INTC(J)', title: "Life's Independent Thinkers", color: 'b' },

                /* --- ROW 2 AND 3 SWAPPED --- */
                /* --- MODIFIED: Alternating colors for chess pattern --- */
                { type: 'ESTM(P)', title: "Making the Most of the Moment", color: 'b' },
                { type: 'ESFM(P)', title: "Let's Make Work Fun", color: 'a' },
                { type: 'ENFM(P)', title: "People Are the Product", color: 'b' },
                { type: 'ENTM(P)', title: "Progress Is the Product", color: 'a' },

                { type: 'ISTM(P)', title: "Just Do It", color: 'a' },
                { type: 'ISFM(P)', title: "Action Speaks Louder Than Words", color: 'b' },
                { type: 'INFM(P)', title: "Making Life Kinder and Gentler", color: 'a' },
                { type: 'INTM(P)', title: "Life's Problem Solvers", color: 'b' },
                /* --- END MODIFIED --- */
                /* --- END SWAP --- */

                { type: 'ESTC(J)', title: "Life's Natural Administrators", color: 'b' },
                { type: 'ESFC(J)', title: "Everyone's Trusted Friend", color: 'a' },
                { type: 'ENFC(J)', title: "Smooth-Talking Persuaders", color: 'b' },
                { type: 'ENTC(J)', title: "Life's Natural Leaders", color: 'a' },
            ];

            // --- App State ---
            let currentQuestionIndex = 0;
            let userAnswers = new Array(questions.length).fill(null);
            let resultsChartInstance = null;
            // let converseChartInstance = null; // No longer a Chart.js instance
            let isAdvancing = false; 
 
            // --- DOM Elements ---
            const coverPage = document.getElementById('coverPage');
            const startBtn = document.getElementById('startBtn');
            const quizSection = document.getElementById('quizSection');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');
            const resultsPage = document.getElementById('resultsPage');
            const printBtn = document.getElementById('printBtn'); // --- MODIFIED: Was restartBtn
            const randomBtn = document.getElementById('randomBtn'); 
            const personalityTypeEl = document.getElementById('personalityType'); 
            const personalityWordsEl = document.getElementById('personalityWords'); 
            const qContainer = document.getElementById('q-container');
            const qNumber = document.getElementById('q-number');
            const qText = document.getElementById('q-text');
            const qOption0 = document.getElementById('q-option-0');
            const qOption1 = document.getElementById('q-option-1');
            const qLabel0 = document.getElementById('q-label-0');
            const qLabel1 = document.getElementById('q-label-1');
            const qRadio0 = document.getElementById('option0'); 
            const qRadio1 = document.getElementById('option1'); 

            // --- NEW: Modal and Grid DOM Elements ---
            const profileGrid = document.getElementById('profileGrid');
            const profileModal = document.getElementById('profileModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const modalTitle = document.getElementById('modalTitle');
            const modalSubtitle = document.getElementById('modalSubtitle');
            const modalDescription = document.getElementById('modalDescription');

            // --- Functions ---

            // --- NEW: Function to populate the 16-profile grid ---
            function populateProfileGrid() {
                if (!profileGrid) return;
                profileGrid.innerHTML = ''; // Clear existing
                
                profileGridData.forEach(profile => {
                    const cell = document.createElement('div');
                    cell.className = 'profile-cell ' + (profile.color === 'a' ? 'cell-color-a' : 'cell-color-b');
                    cell.dataset.type = profile.type; // This will be "ISTC(J)" etc.
                    
                    cell.innerHTML = `
                        <div class="profile-cell-type">${profile.type.replace('C(J)', '<strong>C</strong>').replace('M(P)', '<strong>M</strong>')}</div>
                        <div class="profile-cell-title">${profile.title}</div>
                    `;
                    
                    // Add click listener to show modal
                    cell.addEventListener('click', () => {
                        // Find description using the modified key
                        const description = personalityDescriptions[profile.type]; 
                        
                        if (description) {
                            showProfileModal(profile.type, profile.title, description);
                        } else {
                            console.error('Could not find description for type:', profile.type);
                        }
                    });

                    profileGrid.appendChild(cell);
                });
            }

            // --- NEW: Functions to show/hide the profile modal ---
            // --- MODIFIED: showProfileModal to accept all data ---
            function showProfileModal(type, title, description) {
                modalTitle.innerHTML = type.replace('C(J)', 'C<span class="suffix">(J)</span>').replace('M(P)', 'M<span class="suffix">(P)</span>');
                modalSubtitle.textContent = title;
                modalDescription.textContent = description;
                
                profileModal.style.display = 'flex';
            }

            function hideProfileModal() {
                profileModal.style.display = 'none';
            }
            // --- END NEW ---


            function showQuestion(isInitial = false) {
                const question = questions[currentQuestionIndex];
                const [letter1_raw, letter2_raw] = question.type.split('/');
                const letter1 = letter1_raw.trim();
                const letter2 = letter2_raw.trim();

                const transitionTime = isInitial ? 0 : 200; 

                if (!isInitial) {
                    qContainer.classList.add('transitioning');
                }

                setTimeout(() => {
                    qNumber.textContent = currentQuestionIndex + 1;
                    qText.textContent = question.text;
                    
                    qLabel0.textContent = question.options[0];
                    qOption0.dataset.value = letter1;
                    qRadio0.value = letter1;

                    qLabel1.textContent = question.options[1];
                    qOption1.dataset.value = letter2;
                    qRadio1.value = letter2;

                    qOption0.classList.remove('selected');
                    qOption1.classList.remove('selected');
                    qRadio0.checked = false;
                    qRadio1.checked = false;

                    const previousAnswer = userAnswers[currentQuestionIndex];
                    if (previousAnswer) {
                        if (previousAnswer === letter1) {
                            qOption0.classList.add('selected');
                            qRadio0.checked = true;
                        } else if (previousAnswer === letter2) {
                            qOption1.classList.add('selected');
                            qRadio1.checked = true;
                        }
                    }

                    updateNavigation();

                    if (!isInitial) {
                        qContainer.style.transform = 'translateY(10px)';
                        qContainer.style.transition = 'none'; 
                        void qContainer.offsetHeight; 
                        qContainer.style.transition = 'opacity 0.2s ease-in-out, transform 0.2s ease-in-out';
                        qContainer.style.transform = 'translateY(0)';
                        qContainer.classList.remove('transitioning'); 
                    } else {
                        qContainer.style.opacity = 1; 
                    }
                    
                    isAdvancing = false;

                }, transitionTime);
            }

            function handleOptionClick(optionEl) {
                if (isAdvancing) return; 
                isAdvancing = true; 

                const selectedValue = optionEl.dataset.value;
                userAnswers[currentQuestionIndex] = selectedValue;

                qOption0.classList.remove('selected');
                qOption1.classList.remove('selected');
                optionEl.classList.add('selected');
                
                if (optionEl === qOption0) {
                    qRadio0.checked = true;
                } else {
                    qRadio1.checked = true;
                }

                setTimeout(() => {
                    if (currentQuestionIndex < questions.length - 1) {
                        currentQuestionIndex++;
                        showQuestion(); 
                    } else {
                        updateNavigation();
                        isAdvancing = false; 
                    }
                }, 200); 
            }

            function updateNavigation() {
                prevBtn.disabled = currentQuestionIndex === 0;
                nextBtn.style.display = 'none'; 
                
                if (currentQuestionIndex === questions.length - 1) {
                    finishBtn.style.display = 'inline-block';
                    const allAnswered = userAnswers.every(answer => answer !== null);
                    finishBtn.disabled = !allAnswered;
                } else {
                    finishBtn.style.display = 'none';
                }
            }
            
            // --- Helper function to format the letter for display ---
            function formatLetter(letter) {
                if (letter === 'J') return 'C(J)';
                if (letter === 'P') return 'M(P)';
                return letter;
            }

            // --- Helper function to format the type string ---
            function formatTypeString(type) {
                return type
                    .replace('J', 'C<span class="suffix">(J)</span>')
                    .replace('P', 'M<span class="suffix">(P)</span>');
            }

            // --- MODIFIED: Restored and corrected showResults function ---
            function showResults() {
                quizSection.style.display = 'none';
                resultsPage.style.display = 'block';

                const scores = { E: 0, I: 0, S: 0, N: 0, T: 0, F: 0, J: 0, P: 0 };
                userAnswers.forEach(answer => {
                    if (answer) {
                        scores[answer]++;
                    }
                });

                scores.E *= 2;
                scores.I *= 2;
                
                const maxScores = { E: 22, I: 22, S: 23, N: 23, T: 23, F: 23, J: 23, P: 23 };

                const colorMap = {
                    'E': { bg: 'rgba(68, 179, 225, 0.9)', border: 'rgba(68, 179, 225, 1)' },
                    'I': { bg: 'rgba(234, 228, 0, 0.9)', border: 'rgba(234, 228, 0, 1)' },
                    'S': { bg: 'rgba(255, 153, 0, 0.9)', border: 'rgba(255, 153, 0, 1)' },
                    'N': { bg: 'rgba(120, 33, 112, 0.9)', border: 'rgba(120, 33, 112, 1)' },
                    'T': { bg: 'rgba(33, 92, 152, 0.9)', border: 'rgba(33, 92, 152, 1)' },
                    'F': { bg: 'rgba(78, 167, 46, 0.9)', border: 'rgba(78, 167, 46, 1)' },
                    'J': { bg: 'rgba(235, 21, 21, 0.9)', border: 'rgba(235, 21, 21, 1)' },
                    'P': { bg: 'rgba(153, 102, 51, 0.9)', border: 'rgba(153, 102, 51, 1)' }
                };

                // --- FIX: Restored getPercent function definition ---
                const getPercent = (letter) => {
                    const realScore = scores[letter];
                    const maxScore = maxScores[letter];
                    // Cap the score used for the percentage calculation at 20
                    const scoreForPercent = Math.min(realScore, 20); 
                    // Calculate percentage based on the capped score but the REAL max score
                    return (scoreForPercent / maxScore) * 100;
                };
                // --- END FIX ---

                const finalData = [];
                const otherLetters = []; 
                let realScore, maxScore, percentage; 

                if (scores.E >= scores.I) {
                    realScore = scores.E;
                    maxScore = maxScores.E; 
                    percentage = getPercent('E');
                    finalData.push({ letter: 'E', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('I'); 
                } else {
                    realScore = scores.I;
                    maxScore = maxScores.I; 
                    percentage = getPercent('I');
                    finalData.push({ letter: 'I', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('E'); 
                }

                if (scores.S >= scores.N) {
                    realScore = scores.S;
                    maxScore = maxScores.S; 
                    percentage = getPercent('S');
                    finalData.push({ letter: 'S', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('N'); 
                } else {
                    realScore = scores.N;
                    maxScore = maxScores.N; 
                    percentage = getPercent('N');
                    finalData.push({ letter: 'N', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('S'); 
                }

                if (scores.T >= scores.F) {
                    realScore = scores.T;
                    maxScore = maxScores.T; 
                    percentage = getPercent('T');
                    finalData.push({ letter: 'T', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('F'); 
                } else {
                    realScore = scores.F;
                    maxScore = maxScores.F; 
                    percentage = getPercent('F');
                    finalData.push({ letter: 'F', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('T'); 
                }

                if (scores.J >= scores.P) {
                    realScore = scores.J;
                    maxScore = maxScores.J; 
                    percentage = getPercent('J');
                    finalData.push({ letter: 'J', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('P'); 
                } else {
                    realScore = scores.P;
                    maxScore = maxScores.P; 
                    percentage = getPercent('P');
                    finalData.push({ letter: 'P', score: percentage, realScore: realScore, maxScore: maxScore }); 
                    otherLetters.push('J'); 
                }
                
                // --- MODIFIED: Use formatted letters for chart labels ---
                const chartLabels = finalData.map(d => formatLetter(d.letter)); // e.g., ["E", "S", "T", "C(J)"]
                
                const chartData = finalData.map(d => d.score); // This is now percentage
                const chartRealScores = finalData.map(d => d.realScore); 
                const chartMaxScores = finalData.map(d => d.maxScore); 
                const chartBackgroundColors = finalData.map(d => colorMap[d.letter].bg);
                const chartBorderColors = finalData.map(d => colorMap[d.letter].border);

                // --- MODIFIED: Create the type string (e.g., ESTC(J)) ---
                const personalityTypeString = chartLabels.join(''); // "ESTC(J)"
                const rawTypeString = finalData.map(d => d.letter).join(''); // "ESTJ"
                
                // --- NEW: Highlight the result in the profile grid ---
                // First, clear any existing highlights
                document.querySelectorAll('.profile-cell.highlight').forEach(cell => {
                    cell.classList.remove('highlight');
                });
                
                // Then, add the highlight to the matching cell
                const resultCell = document.querySelector(`.profile-cell[data-type="${personalityTypeString}"]`);
                if (resultCell) {
                    resultCell.classList.add('highlight');
                }
                // --- END NEW ---
                
                // --- MODIFIED: Create opposite type string ---
                const oppositeTypeStringFormatted = otherLetters.map(formatLetter).join(''); // "INFM(P)"
                const oppositeTypeStringRaw = otherLetters.join(''); // "INFP"
                
                // --- NEW: Get and set opposite profile description ---
                const oppositeDescription = personalityDescriptions[oppositeTypeStringFormatted];
                const oppositeDescEl = document.getElementById('oppositeDesc');
                if (oppositeDescEl) {
                    oppositeDescEl.textContent = oppositeDescription || "Description for this type is not available.";
                }
                // --- END NEW ---
                
                const personalityWordsArray = finalData.map(d => {
                    const letter = d.letter; // 'E', 'I', 'S', 'N', 'T', 'F', 'J', 'P'
                    const fullWord = wordMap[letter]; // 'Extroverted', 'Considered', 'iMpromptu'
                    
                    if (letter === 'J') {
                        return `<strong>C</strong>onsidered<span class="suffix">(judging)</span>`;
                    }
                    if (letter === 'P') {
                        return `i<strong>M</strong>promptu<span class="suffix">(perceiving)</span>`;
                    }
                    
                    const keyIndex = fullWord.toLowerCase().indexOf(letter.toLowerCase());
                    if (keyIndex === -1) { return fullWord; }
                    
                    const before = fullWord.substring(0, keyIndex); 
                    const keyChar = fullWord.substring(keyIndex, keyIndex + 1); 
                    const after = fullWord.substring(keyIndex + 1); 
                    return `${before}<strong>${keyChar}</strong>${after}`;
                });
                const personalityWordsHTML = personalityWordsArray.join(' - ');

                if (personalityTypeEl) {
                    // --- MODIFIED: Use formatTypeString helper ---
                    personalityTypeEl.innerHTML = formatTypeString(rawTypeString);
                }
                if (personalityWordsEl) {
                    personalityWordsEl.innerHTML = personalityWordsHTML; 
                }

                const oppositeHeaderEl = document.getElementById('oppositeTypeHeader');
                if (oppositeHeaderEl) {
                    // --- MODIFIED: Use formatTypeString helper ---
                    oppositeHeaderEl.innerHTML = `Your converse profile: ${formatTypeString(oppositeTypeStringRaw)}`; 
                }

                const letterGrid = document.getElementById('letter-grid');
                if (finalData.length === 4) {
                    letterGrid.style.display = 'grid'; 
                    for (let i = 0; i < 4; i++) {
                        const letter = finalData[i].letter; // 'E', 'S', 'T', 'J'
                        const fullWord = wordMap[letter]; // 'Extroverted', 'Sensate', 'Thinking', 'Considered'
                        const description = letterDescriptions[letter];
                        const color = colorMap[letter].border; 
                        const bgColor = color.replace(', 1)', ', 0.1)');

                        const cardElement = document.getElementById(`letter-card-${i}`); 
                        
                        cardElement.style.borderColor = color;
                        cardElement.style.backgroundColor = bgColor; 

                        // --- MODIFIED: Add suffix for J/P ---
                        let titleHTML = fullWord;
                        if (letter === 'J') {
                            titleHTML += `<span class="suffix">(judging)</span>`;
                        } else if (letter === 'P') {
                            titleHTML += `<span class="suffix">(perceiving)</span>`;
                        }
                        document.getElementById(`letter-title-${i}`).innerHTML = titleHTML;
                        document.getElementById(`letter-desc-${i}`).textContent = description;
                    }
                } else {
                    letterGrid.style.display = 'none'; 
                }

                const otherLetterGrid = document.getElementById('other-letter-grid');
                if (otherLetters.length === 4) {
                    for (let i = 0; i < 4; i++) {
                        const letter = otherLetters[i]; // 'I', 'N', 'F', 'P'
                        const fullWord = wordMap[letter]; // 'Introverted', 'iNtuitive', 'Feeling', 'iMpromptu'
                        const description = letterDescriptions[letter];
                        const color = colorMap[letter].border;

                        const cardElement = document.getElementById(`other-letter-card-${i}`);
                        
                        cardElement.style.borderColor = color;
                        
                        // --- MODIFIED: Add suffix for J/P ---
                        let titleHTML = fullWord;
                        if (letter === 'J') {
                            titleHTML += `<span class="suffix">(judging)</span>`;
                        } else if (letter === 'P') {
                            titleHTML += `<span class="suffix">(perceiving)</span>`;
                        }
                        document.getElementById(`other-letter-title-${i}`).innerHTML = titleHTML;
                        document.getElementById(`other-letter-desc-${i}`).textContent = description;
                    }
                }

                // --- MODIFIED: Use formatted string for description key ---
                const description = personalityDescriptions[personalityTypeString] || "Your personality description will appear here.";
                document.getElementById('desc-overview').textContent = description;
                
                // --- Create the main 4-bar chart ---
                const ctx = document.getElementById('resultsChart').getContext('2d');

                if (resultsChartInstance) {
                    resultsChartInstance.destroy();
                }

                resultsChartInstance = new Chart(ctx, {
                    type: 'bar', 
                    data: {
                        labels: chartLabels, // This now contains "C(J)" and "M(P)"
                        datasets: [
                            {
                                label: 'Score',
                                data: chartData, 
                                realScores: chartRealScores, 
                                maxScores: chartMaxScores, 
                                backgroundColor: chartBackgroundColors,
                                borderColor: chartBorderColors,
                                borderWidth: 1,
                                borderRadius: 5,
                                borderSkipped: false,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false 
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const realScore = context.dataset.realScores[context.dataIndex];
                                        const maxScore = context.dataset.maxScores[context.dataIndex];
                                        const percentage = context.dataset.data[context.dataIndex];
                                        
                                        if (label) {
                                            return `${label}: ${percentage.toFixed(1)}% (${realScore}/${maxScore})`;
                                        }
                                        return `${percentage.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                grid: {
                                    display: false, 
                                    borderColor: '#ccc'
                                },
                                ticks: {
                                    font: {
                                        family: 'Poppins',
                                        size: 12, // --- MODIFIED: Reduced size ---
                                        weight: '600'
                                    },
                                    color: '#2c3e50'
                                }
                            },
                            y: { 
                                beginAtZero: true,
                                max: 100, 
                                grid: {
                                    color: function(context) {
                                        if (context.tick.value === 100) return '#2c3e50';
                                        if (context.tick.value === 0) return '#ccc';
                                        return 'transparent';
                                    },
                                    borderColor: '#ccc'
                                },
                                ticks: {
                                    callback: function(value) {
                                        // if (value === 90) return '●'; // Dot removed
                                        return ''; // Hide all labels
                                    },
                                    stepSize: 10,
                                    font: {
                                        family: 'Poppins'
                                    },
                                    color: '#333'
                                }
                            }
                        }
                    }
                });
                // --- END 4-BAR CHART LOGIC ---

                // --- NEW: Call D3 chart creation function ---
                createD3ConverseChart(scores, getPercent);
                // --- END NEW ---

            }
            // --- END OF SHOWRESULTS FUNCTION ---
            
            // --- NEW: D3.js CHART FUNCTION (Replaces Chart.js version) ---
            function createD3ConverseChart(scores, getPercent) {
                
                // 1. Data & Colors
                // Map rgba colors to simple hex for D3
                const d3ColorMap = {
                    'E': '#44b3e1', // rgba(68, 179, 225, 1)
                    'I': '#eae400', // rgba(234, 228, 0, 1)
                    'S': '#ff9900', // rgba(255, 153, 0, 1)
                    'N': '#782170', // rgba(120, 33, 112, 1)
                    'T': '#215c98', // rgba(33, 92, 152, 1)
                    'F': '#4ea72e', // rgba(78, 167, 46, 1)
                    'J': '#eb1515', // rgba(235, 21, 21, 1)
                    'P': '#996633'  // rgba(153, 102, 51, 1)
                };

                const data = [
                    { group: 'E / I', valueA: getPercent('E'), valueB: getPercent('I'), keyA: 'E', keyB: 'I' },
                    { group: 'S / N', valueA: getPercent('S'), valueB: getPercent('N'), keyA: 'S', keyB: 'N' },
                    { group: 'T / F', valueA: getPercent('T'), valueB: getPercent('F'), keyA: 'T', keyB: 'F' },
                    { group: 'C(J) / M(P)', valueA: getPercent('J'), valueB: getPercent('P'), keyA: 'J', keyB: 'P' } // MODIFIED
                ];
                
                const groupKeys = ['valueA', 'valueB'];

                // 2. Chart Setup
                const svg = d3.select("#converseResultsChart");
                svg.html(""); // Clear previous chart
                
                // --- MODIFIED: Make margins smaller for a larger chart area ---
                const margin = { top: 20, right: 20, bottom: 30, left: 40 };
                
                const viewBox = svg.attr("viewBox").split(" ");
                const svgWidth = +viewBox[2];
                const svgHeight = +viewBox[3];

                const width = svgWidth - margin.left - margin.right;
                const height = svgHeight - margin.top - margin.bottom;

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // 3. Scales
                const x0 = d3.scaleBand()
                    .domain(data.map(d => d.group))
                    .rangeRound([0, width])
                    .padding(0.2); // Space between pairs

                const x1 = d3.scaleBand()
                    .domain(groupKeys)
                    .rangeRound([0, x0.bandwidth()])
                    .padding(0); // NO space within a pair

                const yScale = d3.scaleLinear()
                    .domain([0, 100]) // Domain is 0 to 100 percent
                    .nice()
                    .rangeRound([height, 0]);

                // --- NEW: Add Grid Lines (like the first chart) ---
                g.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(yScale)
                        .tickSize(-width) // Extend lines across the chart
                        .tickFormat(() => "") // No labels
                        .tickValues([0, 100]) // Only at 0 and 100
                    )
                    .call(g => g.select(".domain").remove()) // Remove the axis line itself
                    .call(g => g.selectAll(".tick line")
                        .attr("stroke", d => (d === 100 ? '#2c3e50' : '#ccc')) // Match Chart.js colors
                        .attr("stroke-opacity", 1));
                        
                // --- NEW: Add 50% dashed line ---
                // --- MODIFIED: Calculate start and end points to be closer to columns ---
                const lineStartX = x0(data[0].group) - 10; // MODIFIED: extend left
                const lineEndX = x0(data[data.length - 1].group) + x0.bandwidth() + 10; // MODIFIED: extend right
                
                g.append("line")
                    .attr("x1", lineStartX) // Start at the first bar group
                    .attr("y1", yScale(50))
                    .attr("x2", lineEndX) // End at the last bar group
                    .attr("y2", yScale(50))
                    .attr("stroke", "#333") // Dark bold color
                    .attr("stroke-width", 2) // Bold
                    .attr("stroke-dasharray", "6,4"); // Broken line (6 pixels on, 4 off)

                // 4. Axes
                
                // X-Axis
                g.append("g")
                    .attr("class", "axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x0))
                    .call(g => g.select(".domain").remove()) // --- NEW: Remove X-axis domain line ---
                    .call(g => g.selectAll(".tick text") // Style X-axis text to match first chart
                        .attr("font-family", "Poppins")
                        .attr("font-size", "14px")
                        .attr("font-weight", "600")
                        .attr("fill", "#2c3e50"));
                // --- DELETED X-Axis Label ("Dichotomies") ---

                // Y-Axis
                g.append("g")
                    .attr("class", "axis")
                    .call(d3.axisLeft(yScale).tickFormat(() => "")) // Hide tick labels
                    .call(g => g.select(".domain").remove()); // Remove the axis domain line
                // --- DELETED Y-Axis Label ("Score (%)") ---

                // 5. Draw the Bars
                const barGroups = g.append("g")
                    .selectAll("g")
                    .data(data)
                    .join("g")
                    .attr("transform", d => `translate(${x0(d.group)},0)`);

                barGroups.selectAll("rect")
                    .data(d => [
                        { key: 'valueA', value: d.valueA, letter: d.keyA }, 
                        { key: 'valueB', value: d.valueB, letter: d.keyB }
                    ])
                    .join("rect")
                        .attr("x", d => x1(d.key)) 
                        .attr("width", x1.bandwidth())
                        .attr("y", d => yScale(d.value))
                        .attr("height", d => height - yScale(d.value))
                        .attr("fill", d => d3ColorMap[d.letter])
                        .attr("rx", 5); // --- ADDED for rounded corners ---
            }
            // --- END D3.js CHART FUNCTION ---


            function generateRandomResults() {
                if (isAdvancing) return; 
                
                coverPage.style.display = 'none'; 
                quizSection.style.display = 'block'; 

                userAnswers = questions.map(q => {
                    if (typeof q.type !== 'string' || !q.type.includes('/')) {
                        console.error('Invalid question type:', q);
                        return null; 
                    }
                    const [letter1_raw, letter2_raw] = q.type.split('/');
                    const letter1 = letter1_raw.trim();
                    const letter2 = letter2_raw.trim();
                    return Math.random() < 0.5 ? letter1 : letter2;
                });

                showResults(); 
            }


            // --- Event Listeners ---
            startBtn.addEventListener('click', () => { 
                if (isAdvancing) return; 
                isAdvancing = true;    
                coverPage.style.display = 'none'; 
                quizSection.style.display = 'block'; 
                document.body.style.overflow = 'auto'; 
                showQuestion(true); 
            });

            prevBtn.addEventListener('click', () => {
                if (isAdvancing) return; 
                isAdvancing = true; 
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    showQuestion();
                } else {
                    isAdvancing = false; 
                }
            });
            
            nextBtn.addEventListener('click', () => {
                if (isAdvancing) return; 
                isAdvancing = true; 
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    showQuestion();
                } else {
                    isAdvancing = false; 
                }
            });
            
            finishBtn.addEventListener('click', () => {
                if (isAdvancing) return; 
                showResults();
            });
            
            // --- MODIFIED: Changed from restartBtn to printBtn and added print logic ---
            printBtn.addEventListener('click', () => {
                // 1. Force open all accordions on the results page
                document.querySelectorAll('#resultsPage details').forEach(detail => {
                    detail.open = true;
                });
                
                // 2. Force show the converse profile
                const otherGrid = document.getElementById('other-letter-grid');
                const otherBtn = document.getElementById('showOtherBtn');
                const oppositeHeaderEl = document.getElementById('oppositeTypeHeader');
                const oppositeDescEl = document.getElementById('oppositeDesc');
                const converseChartContainer = document.getElementById('converse-chart-container'); // --- NEW ---
    
                if (otherGrid) otherGrid.style.display = 'grid';
                if (oppositeHeaderEl) oppositeHeaderEl.style.display = 'block';
                if (oppositeDescEl) oppositeDescEl.style.display = 'block';
                if (converseChartContainer) converseChartContainer.style.display = 'block'; // --- NEW ---
                if (otherBtn) otherBtn.textContent = 'Hide Converse Profile'; // Keep state consistent
    
                if (resultsChartInstance) {
                    resultsChartInstance.resize();
                }
                // No need to resize D3 SVG
                // 3. Call the print dialog after a short delay
                // This ensures the DOM has time to update with the open sections
                setTimeout(() => {
                    window.print();
                }, 250); 
            });
            // --- END MODIFIED ---

            randomBtn.addEventListener('click', generateRandomResults); 
            qOption0.addEventListener('click', () => handleOptionClick(qOption0));
            qOption1.addEventListener('click', () => handleOptionClick(qOption1));

            // --- Toggle "Other Perspectives" logic ---
            const showOtherBtn = document.getElementById('showOtherBtn');
            const otherLetterGrid = document.getElementById('other-letter-grid');
            const oppositeHeaderEl = document.getElementById('oppositeTypeHeader');
            const oppositeDescEl = document.getElementById('oppositeDesc'); // --- NEW ---
            const converseChartContainer = document.getElementById('converse-chart-container'); // --- NEW ---

            if (showOtherBtn && otherLetterGrid && oppositeHeaderEl && oppositeDescEl && converseChartContainer) { // --- MODIFIED ---
                showOtherBtn.addEventListener('click', () => {
                    const isHidden = otherLetterGrid.style.display === 'none' || otherLetterGrid.style.display === '';
                    if (isHidden) {
                        otherLetterGrid.style.display = 'grid';
                        oppositeHeaderEl.style.display = 'block'; 
                        oppositeDescEl.style.display = 'block'; // --- NEW ---
                        converseChartContainer.style.display = 'block'; // --- NEW ---
                        showOtherBtn.textContent = 'Hide Converse Profile'; 

                        // --- NEW: D3 chart is drawn on show, no resize needed
                        
                    } else {
                        otherLetterGrid.style.display = 'none';
                        oppositeHeaderEl.style.display = 'none'; 
                        oppositeDescEl.style.display = 'none'; // --- NEW ---
                        converseChartContainer.style.display = 'none'; // --- NEW ---
                        showOtherBtn.textContent = 'Show Converse Profile'; 
                    }
                });
            }

            // --- NEW: Grid and Modal Event Listeners ---
            populateProfileGrid(); // Call the function to build the grid

            // --- MODIFIED: Grid click listener is now inside populateProfileGrid ---
            // if (profileGrid) {
            //     profileGrid.addEventListener('click', (e) => {
            //         const cell = e.target.closest('.profile-cell');
            //         if (cell && cell.dataset.type) {
            //             showProfileModal(cell.dataset.type);
            //         }
            //     });
            // }

            if (modalCloseBtn) {
                modalCloseBtn.addEventListener('click', hideProfileModal);
            }

            if (profileModal) {
                profileModal.addEventListener('click', (e) => {
                    // Close if clicking on the overlay (e.target), but not the content
                    if (e.target === profileModal) {
                        hideProfileModal();
                    }
                });
            }
            // --- END NEW ---
            
        }); 
    </script>

</body>
</html>
